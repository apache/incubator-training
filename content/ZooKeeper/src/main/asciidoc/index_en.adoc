////

  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

////


[%notitle]
== Apache ZooKeeper
:description: Brief introduction to Apache ZooKeeper
:keywords: Apache ZooKeeper

image::http://www.apache.org/logos/res/zookeeper/zookeeper.png[]


== Introduction

ZooKeeper is a distributed, highly available, scalable and strictly consistent hierarchical data store


== Introduction
* Current version is 3.4.14 (April 2019)
* A new version 3.5 is under development (3.5.5-beta, May 2019)
** And has been since 2014 or so
** Major new features: Dynamic Reconfiguration, "container" znode, more later
* One of the first tools from the Hadoop ecosystem
* Built at Yahoo!, now an Apache project


== Use Cases
* Foundation for many features in the Hadoop ecosystem
** HA (HBase, YARN, Hive, â€¦)
** Coordination (HBase, ...)
* "Recipes" easily implemented using ZooKeeper:
** Group Membership, Name Service, Configuration, Barriers, Queues, Locks, Leader Election, Two-phased commit
* While ZooKeeper originated within the Hadoop ecosystem it is used heavily outside of it as well
** e.g. Solr and others


== Data Model
image::data-model.png[]


== Data Model
* Hierarchy of nodes (called znode)
** Similar to typical file systems
* Each node can "contain" other nodes as well as data
** Different from file systems where a node is *either* a file *or* a directory
* Data in a node is usually small
** In the kilobyte range


== Data Model
* As all updates are strictly ordered and only a single master processes writes ZooKeeper is not meant as a high-volume data store
* ZooKeeper knows "ephemeral" nodes which get deleted automatically once the session is closed in which it was created
** Can be used to get notified of failed servers
** ZNodes can be watched (i.e. notifications on changes)


== Implementation Details
* ZooKeeper uses a wire protocol based on a library called "Jute"
** Extracted from Hadoop
** Not used outside of ZooKeeper
* There are native clients for C and Java
** Other (e.g. Python) clients maintained by the community
* Apache Curator is a Java based client library that is often easier to use than the native one as it offers higher level concepts


== Zab Protocol
* ZooKeeper can use multiple servers in what's called an "Ensemble"
* ZooKeeper uses an algorithm called Zab to guarantee reliable delivery, total and causal order of messages in the face of unreliable networks
* In an ensemble there is at most one leader server supported by a majority of followers


== Zab Protocol
* All servers elect a leader
** Leader is the one with the most votes (i.e. majority or quorum)
** For this reason usually an odd number of servers
* All servers can serve read requests but all write requests are forwarded to the Leader
** Clients can still talk to any server, they forward the requests appropriately


== Scaling
* All changes in the system are voted upon (coordinated by the Leader)
* The more servers there are the longer this process takes
* Hence the concept of "participants" and "observers" exists
** Participant servers take part in votes
** Observers are non-voting member which only hear the results of votes
* This allows ZooKeeper to scale more easily without sacrificing performance


== ZooKeeper 3.5 - Outlook
* Container nodes
** When all child nodes have been deleted the container node may also be deleted automatically at some point
* TTL nodes
** When creating a node a TTL (in ms) can be specified
** When the node has not been modified within the TTL and there are no children it may also be deleted automatically


== ZooKeeper 3.5 - Outlook
* Dynamic Reconfiguration
** Before 3.5 the membership of the ensemble and all configuration parameters were static, a restart was required to change this
** Starting in 3.5 this (and more) can be changed dynamically without requiring restarts
